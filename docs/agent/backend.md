# Backend Rules

> Load when: working on Python, FastAPI, data models, storage, or tests.

---

## Dependency Management

- Use **UV** exclusively
  - Add a package: `uv add <package>`
  - Run anything: `uv run <script_or_command>`
  - Sync after pulling: `uv sync`
- `pyproject.toml` is the single source of truth for dependencies and tooling config.
- Python version is pinned in `.python-version`. Do not change it without a deliberate decision.

---

## Code Style

- **Prefer simple over clever.** Synchronous, straightforward code is the default for all non-I/O work.
- **Use `async`/`await` for I/O-bound operations** — LLM calls and MCP tool calls in the pipeline are the justified exception. Do not use async elsewhere without a clear blocking reason.
- All function signatures must be type-annotated.
- Use `pydantic` models at every data boundary — API input/output, MCP tool args, inter-stage data.
- One pydantic model per entity is sufficient. Do not split into separate read/write models unless the shapes genuinely differ in a meaningful way.
- No docstrings on obvious functions. Inline comments only for non-obvious logic.
- Tests are colocated with the module they test: `test_<module>.py` in the same directory.

---

## FastAPI Conventions

- Routers are modular — one router per domain area.
- The OpenAPI spec generated by FastAPI is the API contract. Do not handwrite API docs.
- Check current routes and their TypeSpec representation before adding new ones:
  ```bash
  bash scripts/agent/show_typespec.sh
  ```
- Route handlers are thin. Business logic lives in service modules, not in the handler itself.
- Raise `HTTPException` with explicit status codes. Do not swallow errors silently.

---

## Storage

- All state is stored in **JSON files**. There is no database.
- Each domain area owns its JSON file(s). Keep file structure flat and human-readable.
- Read and write through simple helper functions that load and dump JSON. No ORM, no query layer.
- File I/O is synchronous. This is intentional — see code style above.

---

## World State Mutation

Two actors may mutate world state, via different paths:

| Actor      | Allowed path                           | Reason                                   |
|------------|----------------------------------------|------------------------------------------|
| **User**   | FastAPI routes (direct writes to JSON) | Explicit user intent, no indirection needed |
| **LLMs**   | MCP tools only                         | Structured, validated, auditable writes  |

Pipeline stages must never write state through API routes. API routes must never call MCP tools on behalf of a user — that would obscure intent. See `docs/agent/mcp.md` for MCP tool rules.
