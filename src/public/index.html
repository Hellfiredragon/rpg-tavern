<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPG Tavern</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/components.css" />
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx-ext-json-enc@2.0.3"></script>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <h1 class="app-title">RPG Tavern</h1>
      <nav class="tab-bar">
        <button class="tab active" data-tab="adventure">Adventure</button>
        <button class="tab" data-tab="lorebook">Lorebook</button>
        <button class="tab" data-tab="settings">Settings</button>
      </nav>
    </header>

    <!-- Adventure tab -->
    <div class="tab-panel active" id="panel-adventure">
      <div id="adventure-picker"
           hx-get="/api/adventures"
           hx-trigger="load, refreshAdventures from:body"
           hx-swap="innerHTML">
      </div>
      <div id="adventure-play" style="display:none">
        <div class="adventure-location-bar">
          <button class="btn-sm" id="adventure-back-btn">&larr;</button>
          <span class="adventure-name" id="adventure-name"></span>
          <select id="adventure-location-select">
            <option value="">-- Choose a location --</option>
          </select>
        </div>
        <div class="adventure-body">
          <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
              <p class="editor-placeholder">Your adventure begins...</p>
            </div>
            <form class="chat-input-area" id="chat-form">
              <input type="text" id="chat-input" placeholder="What do you do?" autocomplete="off" required />
              <button type="submit">Send</button>
            </form>
          </div>
          <aside class="active-entries-panel" id="active-entries-panel">
            <h3>Active Lore</h3>
            <div id="active-entries-content">
              <p class="active-entries-empty">Start chatting to see active lore.</p>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <!-- Lorebook tab -->
    <div class="tab-panel" id="panel-lorebook">
      <div id="lorebook-picker"
           hx-get="/api/lorebooks"
           hx-trigger="load, refreshLorebooks from:body"
           hx-swap="innerHTML">
      </div>
      <div id="lorebook-edit" style="display:none">
        <div class="lorebook-header-bar">
          <button class="btn-sm" id="lorebook-back-btn">&larr;</button>
          <span id="lorebook-edit-name"></span>
        </div>
        <div class="lorebook-container">
          <div class="lorebook-sidebar">
            <div class="lorebook-tree" id="lorebook-tree"></div>
          </div>
          <div class="lorebook-editor" id="lorebook-editor">
            <p class="editor-placeholder">Select an entry from the tree, or create a new one.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings tab -->
    <div class="tab-panel" id="panel-settings">
      <div class="settings-panel">
        <div id="settings-form" hx-get="/api/settings/form" hx-trigger="load" hx-swap="innerHTML"></div>
      </div>
    </div>
  </div>

  <!-- Dialog: new entry/folder -->
  <dialog id="new-dialog">
    <form id="new-form">
      <h3>Create New</h3>
      <label for="new-name">Path</label>
      <div class="path-input-group">
        <span id="new-prefix" class="path-prefix"></span>
        <input id="new-name" type="text" placeholder="e.g. gabrielle" required />
      </div>
      <div class="editor-actions">
        <button type="submit" id="btn-entry">Create Entry</button>
        <button type="button" id="btn-folder">Create Folder</button>
        <button type="button" class="btn-cancel" id="btn-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: new template -->
  <dialog id="lorebook-dialog">
    <form id="lorebook-form">
      <h3>New Template</h3>
      <label for="lb-new-name">Name</label>
      <input id="lb-new-name" type="text" placeholder="e.g. Fantasy Setting" required />
      <div class="editor-actions">
        <button type="submit">Create</button>
        <button type="button" class="btn-cancel" id="btn-lb-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: copy preset template -->
  <dialog id="lorebook-copy-dialog">
    <form id="lorebook-copy-form">
      <h3>Copy Template</h3>
      <p class="hint" id="lb-copy-source-label"></p>
      <label for="lb-copy-name">New Template Name</label>
      <input id="lb-copy-name" type="text" placeholder="e.g. My Custom Template" required />
      <input type="hidden" id="lb-copy-source" />
      <div class="editor-actions">
        <button type="submit">Copy</button>
        <button type="button" class="btn-cancel" id="btn-lb-copy-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: save adventure as template -->
  <dialog id="adventure-save-tpl-dialog">
    <form id="adventure-save-tpl-form">
      <h3>Save as Template</h3>
      <p class="hint" id="save-tpl-source-label"></p>
      <label for="save-tpl-name">Template Name</label>
      <input id="save-tpl-name" type="text" placeholder="e.g. My Template" required />
      <input type="hidden" id="save-tpl-source" />
      <div class="editor-actions">
        <button type="submit">Save</button>
        <button type="button" class="btn-cancel" id="btn-save-tpl-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: delete adventure -->
  <dialog id="adventure-delete-dialog">
    <form id="adventure-delete-form">
      <h3>Delete Adventure</h3>
      <p>This will permanently delete the adventure and all its save data.</p>
      <p>Type <strong id="adv-del-expected"></strong> to confirm:</p>
      <input id="adv-del-confirm" type="text" placeholder="Type adventure name..." autocomplete="off" required />
      <input type="hidden" id="adv-del-slug" />
      <input type="hidden" id="adv-del-name" />
      <div class="editor-actions">
        <button type="submit" class="btn-danger" id="adv-del-submit" disabled>Delete</button>
        <button type="button" class="btn-cancel" id="btn-adv-del-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: start adventure from template -->
  <dialog id="adventure-template-dialog">
    <form id="adventure-template-form">
      <h3>Start Adventure</h3>
      <p class="hint" id="adv-tpl-source-label"></p>
      <label for="adv-tpl-name">Adventure Name</label>
      <input id="adv-tpl-name" type="text" placeholder="e.g. My Key Quest" required />
      <input type="hidden" id="adv-tpl-source" />
      <div class="editor-actions">
        <button type="submit">Start</button>
        <button type="button" class="btn-cancel" id="btn-adv-tpl-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <script src="/app.js"></script>
</body>
</html>
