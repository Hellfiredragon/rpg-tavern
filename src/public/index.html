<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPG Tavern</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx-ext-json-enc@2.0.3"></script>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <h1 class="app-title">RPG Tavern</h1>
      <nav class="tab-bar">
        <button class="tab active" data-tab="chat">Chat</button>
        <button class="tab" data-tab="lorebook">Lorebook</button>
        <button class="tab" data-tab="settings">Settings</button>
      </nav>
    </header>

    <!-- Chat tab -->
    <div class="tab-panel active" id="panel-chat">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <p class="editor-placeholder">Send a message to begin.</p>
        </div>
        <form class="chat-input-area" id="chat-form">
          <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" required />
          <button type="submit">Send</button>
        </form>
      </div>
    </div>

    <!-- Lorebook tab -->
    <div class="tab-panel" id="panel-lorebook">
      <div class="lorebook-container">
        <div class="lorebook-sidebar">
          <div id="lorebook-selector"
               hx-get="/api/lorebooks"
               hx-trigger="load, refreshLorebooks from:body"
               hx-swap="innerHTML"></div>
          <div class="lorebook-tree" id="lorebook-tree"></div>
        </div>
        <div class="lorebook-editor" id="lorebook-editor">
          <p class="editor-placeholder">Select an entry from the tree, or create a new one.</p>
        </div>
      </div>
    </div>

    <!-- Settings tab -->
    <div class="tab-panel" id="panel-settings">
      <div class="settings-panel">
        <div id="settings-form" hx-get="/api/settings/form" hx-trigger="load" hx-swap="innerHTML"></div>
      </div>
    </div>
  </div>

  <!-- Dialog: new entry/folder -->
  <dialog id="new-dialog">
    <form id="new-form">
      <h3>Create New</h3>
      <label for="new-name">Path</label>
      <div class="path-input-group">
        <span id="new-prefix" class="path-prefix"></span>
        <input id="new-name" type="text" placeholder="e.g. gabrielle" required />
      </div>
      <div class="editor-actions">
        <button type="submit" id="btn-entry">Create Entry</button>
        <button type="button" id="btn-folder">Create Folder</button>
        <button type="button" class="btn-cancel" id="btn-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: new lorebook -->
  <dialog id="lorebook-dialog">
    <form id="lorebook-form">
      <h3>New Lorebook</h3>
      <label for="lb-new-name">Name</label>
      <input id="lb-new-name" type="text" placeholder="e.g. Homebrew Setting" required />
      <div class="editor-actions">
        <button type="submit">Create</button>
        <button type="button" class="btn-cancel" id="btn-lb-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: use template -->
  <dialog id="template-dialog">
    <form id="template-form">
      <h3>Create from Template</h3>
      <p class="hint" id="template-source-label"></p>
      <label for="tpl-name">Lorebook Name</label>
      <input id="tpl-name" type="text" placeholder="e.g. My Adventure" required />
      <input type="hidden" id="tpl-source" />
      <div class="editor-actions">
        <button type="submit">Create</button>
        <button type="button" class="btn-cancel" id="btn-tpl-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <script>
  (function() {
    // -----------------------------------------------------------------------
    // Tab switching
    // -----------------------------------------------------------------------
    var tabs = document.querySelectorAll('.tab');
    var panels = document.querySelectorAll('.tab-panel');

    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        tabs.forEach(function(t) { t.classList.remove('active'); });
        panels.forEach(function(p) { p.classList.remove('active'); });
        tab.classList.add('active');
        document.getElementById('panel-' + tab.getAttribute('data-tab')).classList.add('active');
      });
    });

    // -----------------------------------------------------------------------
    // Chat
    // -----------------------------------------------------------------------
    var chatForm = document.getElementById('chat-form');
    var chatInput = document.getElementById('chat-input');
    var chatMessages = document.getElementById('chat-messages');

    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var msg = chatInput.value.trim();
      if (!msg) return;

      // Clear placeholder if present
      var ph = chatMessages.querySelector('.editor-placeholder');
      if (ph) ph.remove();

      // Add user message
      var userDiv = document.createElement('div');
      userDiv.className = 'chat-msg chat-msg-user';
      userDiv.textContent = msg;
      chatMessages.appendChild(userDiv);
      chatInput.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Send to server
      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      })
      .then(function(res) { return res.text(); })
      .then(function(html) {
        var tmp = document.createElement('div');
        tmp.innerHTML = html;
        while (tmp.firstChild) chatMessages.appendChild(tmp.firstChild);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    });

    // -----------------------------------------------------------------------
    // Lorebook
    // -----------------------------------------------------------------------
    var newDialog = document.getElementById('new-dialog');
    var newForm = document.getElementById('new-form');
    var prefixSpan = document.getElementById('new-prefix');
    var nameInput = document.getElementById('new-name');

    var lbDialog = document.getElementById('lorebook-dialog');
    var lbForm = document.getElementById('lorebook-form');
    var lbNameInput = document.getElementById('lb-new-name');

    var currentLorebook = 'default';
    var currentPrefix = '';

    function refreshTree() {
      htmx.ajax('GET', '/api/lorebook/tree?lorebook=' + encodeURIComponent(currentLorebook), {
        target: '#lorebook-tree', swap: 'innerHTML'
      });
    }

    document.body.addEventListener('refreshTree', function() {
      refreshTree();
    });

    // After lorebook selector loads, bind change handler and do initial tree load
    document.body.addEventListener('htmx:afterSettle', function(evt) {
      if (evt.detail.target && evt.detail.target.id === 'lorebook-selector') {
        var sel = document.getElementById('lorebook-select');
        if (sel) {
          sel.addEventListener('change', function() {
            currentLorebook = sel.value;
            refreshTree();
            document.getElementById('lorebook-editor').innerHTML =
              '<p class="editor-placeholder">Select an entry from the tree, or create a new one.</p>';
          });
          currentLorebook = sel.value || 'default';
        }
        refreshTree();
      }
    });

    // Event delegation for dynamic buttons
    document.addEventListener('click', function(e) {
      // "+ New" entry/folder buttons in tree
      var btn = e.target.closest('.btn-new-entry');
      if (btn) {
        currentPrefix = btn.getAttribute('data-prefix') || '';
        prefixSpan.textContent = currentPrefix;
        nameInput.value = '';
        newDialog.showModal();
        nameInput.focus();
        return;
      }

      // "+ Lorebook" button
      if (e.target.id === 'btn-new-lorebook' || e.target.closest('#btn-new-lorebook')) {
        lbNameInput.value = '';
        lbDialog.showModal();
        lbNameInput.focus();
        return;
      }
    });

    // --- New entry/folder dialog ---
    document.getElementById('btn-cancel').addEventListener('click', function() {
      newDialog.close();
    });

    newForm.addEventListener('submit', function(e) {
      e.preventDefault();
    });

    function getFullPath() {
      var name = nameInput.value.trim();
      if (!name) { nameInput.focus(); return null; }
      return currentPrefix + name;
    }

    nameInput.addEventListener('keydown', function(e) {
      if (e.key !== 'Enter') return;
      e.preventDefault();
      var path = getFullPath();
      if (!path) return;
      newDialog.close();
      if (path.endsWith('/')) {
        htmx.ajax('POST', '/api/lorebook/folder?lorebook=' + encodeURIComponent(currentLorebook), {
          target: '#lorebook-tree', swap: 'innerHTML', values: { path: path.replace(/\/$/, '') }
        });
      } else {
        htmx.ajax('GET', '/api/lorebook/entry?path=' + encodeURIComponent(path) + '&lorebook=' + encodeURIComponent(currentLorebook), {
          target: '#lorebook-editor', swap: 'innerHTML'
        });
      }
    });

    document.getElementById('btn-entry').addEventListener('click', function() {
      var path = getFullPath();
      if (!path) return;
      if (path.endsWith('/')) { nameInput.focus(); return; }
      newDialog.close();
      htmx.ajax('GET', '/api/lorebook/entry?path=' + encodeURIComponent(path) + '&lorebook=' + encodeURIComponent(currentLorebook), {
        target: '#lorebook-editor', swap: 'innerHTML'
      });
    });

    document.getElementById('btn-folder').addEventListener('click', function() {
      var name = nameInput.value.trim();
      if (!name) { nameInput.focus(); return; }
      var path = currentPrefix + name;
      newDialog.close();
      htmx.ajax('POST', '/api/lorebook/folder?lorebook=' + encodeURIComponent(currentLorebook), {
        target: '#lorebook-tree', swap: 'innerHTML', values: { path: path }
      });
    });

    // --- New lorebook dialog ---
    document.getElementById('btn-lb-cancel').addEventListener('click', function() {
      lbDialog.close();
    });

    lbForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var name = lbNameInput.value.trim();
      if (!name) { lbNameInput.focus(); return; }
      var slug = name.toLowerCase().replace(/[^a-z0-9_-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      if (!slug) { lbNameInput.focus(); return; }
      lbDialog.close();
      fetch('/api/lorebooks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: slug, name: name })
      }).then(function() {
        htmx.trigger(document.body, 'refreshLorebooks');
        setTimeout(function() {
          var sel = document.getElementById('lorebook-select');
          if (sel) {
            sel.value = slug;
            currentLorebook = slug;
            refreshTree();
          }
        }, 300);
      });
    });

    // --- Template dialog ---
    var tplDialog = document.getElementById('template-dialog');
    var tplForm = document.getElementById('template-form');
    var tplNameInput = document.getElementById('tpl-name');
    var tplSource = document.getElementById('tpl-source');
    var tplSourceLabel = document.getElementById('template-source-label');

    document.addEventListener('click', function(e) {
      if (e.target.id === 'btn-use-template' || e.target.closest('#btn-use-template')) {
        var sel = document.getElementById('template-select');
        if (!sel) return;
        var source = sel.value;
        var label = sel.options[sel.selectedIndex].text;
        tplSource.value = source;
        tplSourceLabel.textContent = 'Template: ' + label;
        tplNameInput.value = '';
        tplDialog.showModal();
        tplNameInput.focus();
      }
    });

    document.getElementById('btn-tpl-cancel').addEventListener('click', function() {
      tplDialog.close();
    });

    tplForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var name = tplNameInput.value.trim();
      if (!name) { tplNameInput.focus(); return; }
      var slug = name.toLowerCase().replace(/[^a-z0-9_-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      if (!slug) { tplNameInput.focus(); return; }
      var source = tplSource.value;
      tplDialog.close();
      fetch('/api/lorebooks/copy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ source: source, slug: slug, name: name })
      }).then(function() {
        htmx.trigger(document.body, 'refreshLorebooks');
        setTimeout(function() {
          var sel = document.getElementById('lorebook-select');
          if (sel) {
            sel.value = slug;
            currentLorebook = slug;
            refreshTree();
          }
        }, 300);
      });
    });
  })();
  </script>
</body>
</html>
