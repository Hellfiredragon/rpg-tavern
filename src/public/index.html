<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPG Tavern</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx-ext-json-enc@2.0.3"></script>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <h1 class="app-title">RPG Tavern</h1>
      <nav class="tab-bar">
        <button class="tab active" data-tab="adventure">Adventure</button>
        <button class="tab" data-tab="lorebook">Lorebook</button>
        <button class="tab" data-tab="settings">Settings</button>
      </nav>
    </header>

    <!-- Adventure tab -->
    <div class="tab-panel active" id="panel-adventure">
      <div id="adventure-picker"
           hx-get="/api/adventures"
           hx-trigger="load, refreshAdventures from:body"
           hx-swap="innerHTML">
      </div>
      <div id="adventure-play" style="display:none">
        <div class="adventure-location-bar">
          <button class="btn-sm" id="adventure-back-btn">&larr;</button>
          <span class="adventure-name" id="adventure-name"></span>
          <select id="adventure-location-select">
            <option value="">-- Choose a location --</option>
          </select>
        </div>
        <div class="chat-container">
          <div class="chat-messages" id="chat-messages">
            <p class="editor-placeholder">Your adventure begins...</p>
          </div>
          <form class="chat-input-area" id="chat-form">
            <input type="text" id="chat-input" placeholder="What do you do?" autocomplete="off" required />
            <button type="submit">Send</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Lorebook tab -->
    <div class="tab-panel" id="panel-lorebook">
      <div class="lorebook-container">
        <div class="lorebook-sidebar">
          <div id="lorebook-selector"
               hx-get="/api/lorebooks"
               hx-trigger="load, refreshLorebooks from:body"
               hx-swap="innerHTML"></div>
          <div class="lorebook-tree" id="lorebook-tree"></div>
        </div>
        <div class="lorebook-editor" id="lorebook-editor">
          <p class="editor-placeholder">Select an entry from the tree, or create a new one.</p>
        </div>
      </div>
    </div>

    <!-- Settings tab -->
    <div class="tab-panel" id="panel-settings">
      <div class="settings-panel">
        <div id="settings-form" hx-get="/api/settings/form" hx-trigger="load" hx-swap="innerHTML"></div>
      </div>
    </div>
  </div>

  <!-- Dialog: new entry/folder -->
  <dialog id="new-dialog">
    <form id="new-form">
      <h3>Create New</h3>
      <label for="new-name">Path</label>
      <div class="path-input-group">
        <span id="new-prefix" class="path-prefix"></span>
        <input id="new-name" type="text" placeholder="e.g. gabrielle" required />
      </div>
      <div class="editor-actions">
        <button type="submit" id="btn-entry">Create Entry</button>
        <button type="button" id="btn-folder">Create Folder</button>
        <button type="button" class="btn-cancel" id="btn-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: new lorebook -->
  <dialog id="lorebook-dialog">
    <form id="lorebook-form">
      <h3>New Lorebook</h3>
      <label for="lb-new-name">Name</label>
      <input id="lb-new-name" type="text" placeholder="e.g. Homebrew Setting" required />
      <div class="editor-actions">
        <button type="submit">Create</button>
        <button type="button" class="btn-cancel" id="btn-lb-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: use template -->
  <dialog id="template-dialog">
    <form id="template-form">
      <h3>Create from Template</h3>
      <p class="hint" id="template-source-label"></p>
      <label for="tpl-name">Lorebook Name</label>
      <input id="tpl-name" type="text" placeholder="e.g. My Adventure" required />
      <input type="hidden" id="tpl-source" />
      <div class="editor-actions">
        <button type="submit">Create</button>
        <button type="button" class="btn-cancel" id="btn-tpl-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: delete adventure -->
  <dialog id="adventure-delete-dialog">
    <form id="adventure-delete-form">
      <h3>Delete Adventure</h3>
      <p>This will permanently delete the adventure and all its save data.</p>
      <p>Type <strong id="adv-del-expected"></strong> to confirm:</p>
      <input id="adv-del-confirm" type="text" placeholder="Type adventure name..." autocomplete="off" required />
      <input type="hidden" id="adv-del-slug" />
      <input type="hidden" id="adv-del-name" />
      <div class="editor-actions">
        <button type="submit" class="btn-danger" id="adv-del-submit" disabled>Delete</button>
        <button type="button" class="btn-cancel" id="btn-adv-del-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog: start adventure from template -->
  <dialog id="adventure-template-dialog">
    <form id="adventure-template-form">
      <h3>Start Adventure</h3>
      <p class="hint" id="adv-tpl-source-label"></p>
      <label for="adv-tpl-name">Adventure Name</label>
      <input id="adv-tpl-name" type="text" placeholder="e.g. My Key Quest" required />
      <input type="hidden" id="adv-tpl-source" />
      <div class="editor-actions">
        <button type="submit">Start</button>
        <button type="button" class="btn-cancel" id="btn-adv-tpl-cancel">Cancel</button>
      </div>
    </form>
  </dialog>

  <script>
  (function() {
    // -----------------------------------------------------------------------
    // Tab switching
    // -----------------------------------------------------------------------
    var tabs = document.querySelectorAll('.tab');
    var panels = document.querySelectorAll('.tab-panel');

    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        tabs.forEach(function(t) { t.classList.remove('active'); });
        panels.forEach(function(p) { p.classList.remove('active'); });
        tab.classList.add('active');
        document.getElementById('panel-' + tab.getAttribute('data-tab')).classList.add('active');
      });
    });

    // -----------------------------------------------------------------------
    // Adventure state
    // -----------------------------------------------------------------------
    var currentAdventure = '';   // lorebook slug
    var currentChatId = '';
    var currentLocation = '';
    var adventureName = '';

    var chatForm = document.getElementById('chat-form');
    var chatInput = document.getElementById('chat-input');
    var chatMessages = document.getElementById('chat-messages');
    var adventurePicker = document.getElementById('adventure-picker');
    var adventurePlay = document.getElementById('adventure-play');
    var adventureNameEl = document.getElementById('adventure-name');
    var locationSelect = document.getElementById('adventure-location-select');

    function showAdventurePicker() {
      adventurePicker.style.display = '';
      adventurePlay.style.display = 'none';
      currentAdventure = '';
      currentChatId = '';
      currentLocation = '';
      adventureName = '';
      htmx.trigger(document.body, 'refreshAdventures');
    }

    function startAdventure(lorebook, chatId, name, location) {
      currentAdventure = lorebook;
      currentChatId = chatId;
      currentLocation = location || '';
      adventureName = name;

      adventurePicker.style.display = 'none';
      adventurePlay.style.display = '';
      adventureNameEl.textContent = name;

      // Load locations into dropdown
      fetch('/api/adventures/locations?lorebook=' + encodeURIComponent(lorebook))
        .then(function(res) { return res.text(); })
        .then(function(html) {
          locationSelect.innerHTML = html;
          if (currentLocation) locationSelect.value = currentLocation;
        });

      // Load chat messages
      htmx.ajax('GET', '/api/chats/messages?id=' + encodeURIComponent(chatId), {
        target: '#chat-messages', swap: 'innerHTML'
      }).then(function() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    // Back button
    document.getElementById('adventure-back-btn').addEventListener('click', showAdventurePicker);

    // Location change
    locationSelect.addEventListener('change', function() {
      var loc = locationSelect.value;
      if (!loc || !currentChatId) return;

      fetch('/api/adventures/location', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chatId: currentChatId, location: loc })
      })
      .then(function(res) {
        var newLoc = res.headers.get('X-Location');
        if (newLoc) currentLocation = newLoc;
        return res.text();
      })
      .then(function(html) {
        // Clear placeholder if present
        var ph = chatMessages.querySelector('.editor-placeholder');
        if (ph) ph.remove();
        var tmp = document.createElement('div');
        tmp.innerHTML = html;
        while (tmp.firstChild) chatMessages.appendChild(tmp.firstChild);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    });

    // Send message
    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var msg = chatInput.value.trim();
      if (!msg) return;

      // Clear placeholder if present
      var ph = chatMessages.querySelector('.editor-placeholder');
      if (ph) ph.remove();

      // Add user message
      var userDiv = document.createElement('div');
      userDiv.className = 'chat-msg chat-msg-user';
      userDiv.textContent = msg;
      chatMessages.appendChild(userDiv);
      chatInput.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Send to server
      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg, chatId: currentChatId, lorebook: currentAdventure })
      })
      .then(function(res) {
        var newId = res.headers.get('X-Chat-Id');
        if (newId) currentChatId = newId;
        return res.text();
      })
      .then(function(html) {
        var tmp = document.createElement('div');
        tmp.innerHTML = html;
        while (tmp.firstChild) chatMessages.appendChild(tmp.firstChild);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    });

    // -----------------------------------------------------------------------
    // Adventure picker event delegation
    // -----------------------------------------------------------------------
    document.addEventListener('click', function(e) {
      // Continue button
      var contBtn = e.target.closest('.adventure-continue-btn');
      if (contBtn) {
        startAdventure(
          contBtn.getAttribute('data-lorebook'),
          contBtn.getAttribute('data-chat-id'),
          contBtn.getAttribute('data-name'),
          contBtn.getAttribute('data-location')
        );
        return;
      }

      // Delete button
      var delBtn = e.target.closest('.adventure-delete-btn');
      if (delBtn) {
        var slug = delBtn.getAttribute('data-lorebook');
        var name = delBtn.getAttribute('data-name');
        document.getElementById('adv-del-slug').value = slug;
        document.getElementById('adv-del-name').value = name;
        document.getElementById('adv-del-expected').textContent = name;
        document.getElementById('adv-del-confirm').value = '';
        document.getElementById('adv-del-submit').disabled = true;
        document.getElementById('adventure-delete-dialog').showModal();
        document.getElementById('adv-del-confirm').focus();
        return;
      }

      // Start from template button
      var startBtn = e.target.closest('.adventure-start-btn');
      if (startBtn) {
        var source = startBtn.getAttribute('data-template');
        var label = startBtn.getAttribute('data-name');
        document.getElementById('adv-tpl-source').value = source;
        document.getElementById('adv-tpl-source-label').textContent = 'Template: ' + label;
        document.getElementById('adv-tpl-name').value = '';
        document.getElementById('adventure-template-dialog').showModal();
        document.getElementById('adv-tpl-name').focus();
        return;
      }
    });

    // Adventure template dialog
    document.getElementById('btn-adv-tpl-cancel').addEventListener('click', function() {
      document.getElementById('adventure-template-dialog').close();
    });

    document.getElementById('adventure-template-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var nameInput = document.getElementById('adv-tpl-name');
      var name = nameInput.value.trim();
      if (!name) { nameInput.focus(); return; }
      var slug = name.toLowerCase().replace(/[^a-z0-9_-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      if (!slug) { nameInput.focus(); return; }
      var source = document.getElementById('adv-tpl-source').value;
      document.getElementById('adventure-template-dialog').close();

      fetch('/api/lorebooks/copy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ source: source, slug: slug, name: name })
      }).then(function() {
        return fetch('/api/chats', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lorebook: slug })
        });
      }).then(function(res) {
        var chatId = res.headers.get('X-Chat-Id');
        if (chatId) startAdventure(slug, chatId, name, '');
      });
    });

    // Adventure delete dialog
    document.getElementById('btn-adv-del-cancel').addEventListener('click', function() {
      document.getElementById('adventure-delete-dialog').close();
    });

    document.getElementById('adv-del-confirm').addEventListener('input', function() {
      var expected = document.getElementById('adv-del-name').value;
      document.getElementById('adv-del-submit').disabled = (this.value !== expected);
    });

    document.getElementById('adventure-delete-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var slug = document.getElementById('adv-del-slug').value;
      var expected = document.getElementById('adv-del-name').value;
      if (document.getElementById('adv-del-confirm').value !== expected) return;
      document.getElementById('adventure-delete-dialog').close();
      fetch('/api/adventures?lorebook=' + encodeURIComponent(slug), { method: 'DELETE' })
        .then(function() {
          htmx.trigger(document.body, 'refreshAdventures');
        });
    });

    // -----------------------------------------------------------------------
    // Lorebook
    // -----------------------------------------------------------------------
    var newDialog = document.getElementById('new-dialog');
    var newForm = document.getElementById('new-form');
    var prefixSpan = document.getElementById('new-prefix');
    var nameInput = document.getElementById('new-name');

    var lbDialog = document.getElementById('lorebook-dialog');
    var lbForm = document.getElementById('lorebook-form');
    var lbNameInput = document.getElementById('lb-new-name');

    var currentLorebook = 'default';
    var currentPrefix = '';

    function refreshTree() {
      htmx.ajax('GET', '/api/lorebook/tree?lorebook=' + encodeURIComponent(currentLorebook), {
        target: '#lorebook-tree', swap: 'innerHTML'
      });
    }

    document.body.addEventListener('refreshTree', function() {
      refreshTree();
    });

    // After lorebook selector loads, bind change handler and do initial tree load
    document.body.addEventListener('htmx:afterSettle', function(evt) {
      if (evt.detail.target && evt.detail.target.id === 'lorebook-selector') {
        var sel = document.getElementById('lorebook-select');
        if (sel) {
          sel.addEventListener('change', function() {
            currentLorebook = sel.value;
            refreshTree();
            document.getElementById('lorebook-editor').innerHTML =
              '<p class="editor-placeholder">Select an entry from the tree, or create a new one.</p>';
          });
          currentLorebook = sel.value || 'default';
        }
        refreshTree();
      }
    });

    // Event delegation for dynamic buttons
    document.addEventListener('click', function(e) {
      // "+ New" entry/folder buttons in tree
      var btn = e.target.closest('.btn-new-entry');
      if (btn) {
        currentPrefix = btn.getAttribute('data-prefix') || '';
        prefixSpan.textContent = currentPrefix;
        nameInput.value = '';
        newDialog.showModal();
        nameInput.focus();
        return;
      }

      // "+ Lorebook" button
      if (e.target.id === 'btn-new-lorebook' || e.target.closest('#btn-new-lorebook')) {
        lbNameInput.value = '';
        lbDialog.showModal();
        lbNameInput.focus();
        return;
      }
    });

    // --- New entry/folder dialog ---
    document.getElementById('btn-cancel').addEventListener('click', function() {
      newDialog.close();
    });

    newForm.addEventListener('submit', function(e) {
      e.preventDefault();
    });

    function getFullPath() {
      var name = nameInput.value.trim();
      if (!name) { nameInput.focus(); return null; }
      return currentPrefix + name;
    }

    nameInput.addEventListener('keydown', function(e) {
      if (e.key !== 'Enter') return;
      e.preventDefault();
      var path = getFullPath();
      if (!path) return;
      newDialog.close();
      if (path.endsWith('/')) {
        htmx.ajax('POST', '/api/lorebook/folder?lorebook=' + encodeURIComponent(currentLorebook), {
          target: '#lorebook-tree', swap: 'innerHTML', values: { path: path.replace(/\/$/, '') }
        });
      } else {
        htmx.ajax('GET', '/api/lorebook/entry?path=' + encodeURIComponent(path) + '&lorebook=' + encodeURIComponent(currentLorebook), {
          target: '#lorebook-editor', swap: 'innerHTML'
        });
      }
    });

    document.getElementById('btn-entry').addEventListener('click', function() {
      var path = getFullPath();
      if (!path) return;
      if (path.endsWith('/')) { nameInput.focus(); return; }
      newDialog.close();
      htmx.ajax('GET', '/api/lorebook/entry?path=' + encodeURIComponent(path) + '&lorebook=' + encodeURIComponent(currentLorebook), {
        target: '#lorebook-editor', swap: 'innerHTML'
      });
    });

    document.getElementById('btn-folder').addEventListener('click', function() {
      var name = nameInput.value.trim();
      if (!name) { nameInput.focus(); return; }
      var path = currentPrefix + name;
      newDialog.close();
      htmx.ajax('POST', '/api/lorebook/folder?lorebook=' + encodeURIComponent(currentLorebook), {
        target: '#lorebook-tree', swap: 'innerHTML', values: { path: path }
      });
    });

    // --- New lorebook dialog ---
    document.getElementById('btn-lb-cancel').addEventListener('click', function() {
      lbDialog.close();
    });

    lbForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var name = lbNameInput.value.trim();
      if (!name) { lbNameInput.focus(); return; }
      var slug = name.toLowerCase().replace(/[^a-z0-9_-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      if (!slug) { lbNameInput.focus(); return; }
      lbDialog.close();
      fetch('/api/lorebooks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: slug, name: name })
      }).then(function() {
        htmx.trigger(document.body, 'refreshLorebooks');
        setTimeout(function() {
          var sel = document.getElementById('lorebook-select');
          if (sel) {
            sel.value = slug;
            currentLorebook = slug;
            refreshTree();
          }
        }, 300);
      });
    });

    // --- Template dialog ---
    var tplDialog = document.getElementById('template-dialog');
    var tplForm = document.getElementById('template-form');
    var tplNameInput = document.getElementById('tpl-name');
    var tplSource = document.getElementById('tpl-source');
    var tplSourceLabel = document.getElementById('template-source-label');

    document.addEventListener('click', function(e) {
      if (e.target.id === 'btn-use-template' || e.target.closest('#btn-use-template')) {
        var sel = document.getElementById('template-select');
        if (!sel) return;
        var source = sel.value;
        var label = sel.options[sel.selectedIndex].text;
        tplSource.value = source;
        tplSourceLabel.textContent = 'Template: ' + label;
        tplNameInput.value = '';
        tplDialog.showModal();
        tplNameInput.focus();
      }
    });

    document.getElementById('btn-tpl-cancel').addEventListener('click', function() {
      tplDialog.close();
    });

    tplForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var name = tplNameInput.value.trim();
      if (!name) { tplNameInput.focus(); return; }
      var slug = name.toLowerCase().replace(/[^a-z0-9_-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      if (!slug) { tplNameInput.focus(); return; }
      var source = tplSource.value;
      tplDialog.close();
      fetch('/api/lorebooks/copy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ source: source, slug: slug, name: name })
      }).then(function() {
        htmx.trigger(document.body, 'refreshLorebooks');
        setTimeout(function() {
          var sel = document.getElementById('lorebook-select');
          if (sel) {
            sel.value = slug;
            currentLorebook = slug;
            refreshTree();
          }
        }, 300);
      });
    });
  })();
  </script>
</body>
</html>
