# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

RPG Tavern is an LLM-powered RPG engine. Players connect, describe what their characters want to do, and the server uses LLMs to alter world state and narrate the story. Data is stored as files on disk.

## Tech Stack

- **Backend:** Python 3.12+ with FastAPI, managed by **uv**
- **Frontend:** React 19 + TypeScript with Vite, managed by **bun**
- Backend serves the built frontend as static files from `backend/static/`

## Commands

### Development

```bash
uv run main.py              # Start backend + frontend in watch mode
uv run main.py --demo       # Same, but wipe and recreate demo templates first
uv run main.py --data-dir /tmp/rpg  # Use a custom data directory
```

### Backend only

```bash
uv run uvicorn backend.app:app --reload --port 13013   # Start backend with hot-reload
uv add <package>                                        # Add a Python dependency
```

### Tests

```bash
uv run pytest                       # Run all tests
uv run pytest tests/test_storage.py # Run a single test file
uv run pytest -k test_create        # Run tests matching a pattern
```

### Frontend only

```bash
cd frontend && bun run dev       # Vite dev server (proxies /api → backend)
cd frontend && bun run build     # Build to backend/static/
cd frontend && bun run lint      # ESLint
```

## Architecture

```
backend/              Python backend (FastAPI)
  app.py              App factory (create_app with configurable data_dir)
  routes.py           API endpoints under /api (/templates, /adventures, /settings, /name-suggestion)
  storage.py          File-based JSON storage (split templates + adventures, preset merging, config)
  demo.py             Demo data generator (--demo flag)
  static/             Built frontend assets (gitignored, generated by `bun run build`)

frontend/             React + TypeScript (Vite)
  src/
    App.tsx            URL router: / → QuestBoard, /templates/:slug, /adventures/:slug, /settings
    Layout.tsx         Shell with header breadcrumb (adventure name + back link)
    QuestBoard.tsx     Quest board with "Running Adventures" and "Templates" sections
    AdventureView.tsx  Tab-based view (Chat/World/Settings) for template or adventure
    EmbarkDialog.tsx   Modal dialog for naming an adventure before embarking
    AppSettings.tsx    Settings page (LLM connection, display preferences)
  vite.config.ts      Build output → ../backend/static, dev proxy /api → backend

presets/              Built-in content (committed to git, read-only at runtime)
  templates/           Preset templates (merged with user templates, copy-on-write)
  adventure-names.txt  Name generation word lists (periods + epithets)

data/                 Runtime data storage (gitignored, default location)
  templates/           User-created and overridden templates
  adventures/          Running adventures (created via embark)
data-tests/           Test data (gitignored, wiped before each test)
.env.example          Default config (copy to .env to override)
ARCH-DESIGN.md        Data model and object tree storage design
```

### Configuration (.env)

All ports/host are configured via `.env` at the project root (see `.env.example`). Vite reads it via `loadEnv()`, Python via `python-dotenv`. Key vars: `HOST`, `BACKEND_PORT`, `FRONTEND_PORT`, `DATA_DIR`.

### Data storage

Objects are stored as a tree on disk — see [ARCH-DESIGN.md](ARCH-DESIGN.md) for the full model. Each object has a title slugified to an ASCII path (`"The Cursed Tavern"` → `the-cursed-tavern`). Data lives in `<slug>.json`, children in `<slug>/`. No IDs or UUIDs — the path is the reference.

Templates and adventures are stored in separate directories:
- `data/templates/` — user-created templates (+ copy-on-write overrides of presets)
- `data/adventures/` — running adventures (created by embarking from a template)
- `presets/templates/` — built-in templates (read-only, committed to git, merged at read time)

Configurable via `DATA_DIR` env or `--data-dir` flag. Tests use `data-tests/` which is wiped before each test run.

### Dev proxy setup

In development, the Vite dev server proxies `/api/*` requests to the backend. In production, the backend serves everything — API routes and static frontend files — from a single port.

## Workflow

- After completing a piece of work, write the commit message into `.gitmessage` — this includes doc-only changes (CLAUDE.md, ARCH-DESIGN.md, etc.)
- **Commit messages** use semantic prefixes: `feat(topic):`, `fix(topic):`, `chore(topic):`, `refactor(topic):`, `test(topic):`, `docs(topic):`
- Keep TODOS.md updated when completing items listed there
- Update CLAUDE.md
- Update `backend/demo.py` when data model or storage changes so `--demo` generates valid, representative demo data